name: Validate declarations

on:
  push:
  pull_request:
    types: [ opened, reopened ]

jobs:
  # validate_schema:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v2
  #       with:
  #         node-version: 14
  #     - run: npm install
  #     - run: npm run test:schema

  validate_modified_declarations:
    runs-on: ubuntu-latest
    steps:
      - uses: kolpav/purge-artifacts-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          expire-in: 0 # Set this to 0 to delete all artifacts
      - name: Set env
        run: | 
          RUN_INFO=`curl -s https://api.github.com/repos/${{github.repository}}/actions/runs/${{ github.run_id }} | jq`
          echo ${{ github.run_id }}
          echo $RUN_INFO | jq
          GITHUB_CHECK_SUITE_ID=`curl -s https://api.github.com/repos/${{github.repository}}/actions/runs/${{ github.run_id }} | jq -r '.check_suite_id'`
          GITHUB_PR_NUMBER=`curl -s https://api.github.com/repos/${{github.repository}}/actions/runs/${{ github.run_id }} | jq -r '.pull_requests[0].number'`
          echo "GITHUB_CHECK_SUITE_ID=$GITHUB_CHECK_SUITE_ID" >> $GITHUB_ENV
          echo "GITHUB_PR_NUMBER=$GITHUB_PR_NUMBER" >> $GITHUB_ENV
      - uses: hmarr/debug-action@v2
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - run: npm install
      - run: npm run test:modified
      - uses: actions/upload-artifact@v3
        with:
          name: artifact-${{env.GITHUB_CHECK_SUITE_ID}}
          path: ./.tmp
          if-no-files-found: error
      - name: Set env
        run: | 
          RUN_INFO=`curl -s https://api.github.com/repos/${{github.repository}}/actions/artifacts`
          echo $RUN_INFO | jq
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          pr_number: ${{env.GITHUB_PR_NUMBER}}
          comment_includes: 'Hello world'
          message: |
            Hello world !
            https://github.com/${{github.repository}}/suites/${{env.GITHUB_CHECK_SUITE_ID}}/artifacts/${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
